import os, json, io
from flask import Flask, render_template, request, session, send_file, redirect
from datetime import datetime, timedelta

app = Flask(__name__)
app.secret_key = "valerio_centrale_2026"

# Database fittizio per lo stato globale dei furgoni
DB_FILE = "stato_furgoni.json"

def carica_stato():
    if not os.path.exists(DB_FILE):
        return {
            "GA087CH": {"stato": "Libero", "posizione": "Tiburtina", "km": 0, "autista": "-", "alert": ""},
            "GX942TS": {"stato": "Libero", "posizione": "Tiburtina", "km": 0, "autista": "-", "alert": ""},
            "GG862HC": {"stato": "Libero", "posizione": "Tiburtina", "km": 0, "autista": "-", "alert": ""}
        }
    with open(DB_FILE, "r") as f: return json.load(f)

def salva_stato(stato):
    with open(DB_FILE, "w") as f: json.dump(stato, f)

@app.route("/", methods=["GET", "POST"])
def index():
    stato_globale = carica_stato()
    
    if request.method == "POST":
        azione = request.form.get("azione")
        targa = request.form.get("targa")
        
        if azione == "start":
            autista = request.form.get("autista")
            km_p = int(request.form.get("km_partenza"))
            # Aggiorno stato globale
            stato_globale[targa] = {
                "stato": "In Viaggio",
                "posizione": request.form.get("partenza"),
                "km": km_p,
                "autista": autista,
                "alert": ""
            }
            salva_stato(stato_globale)
            session[f"corsa_{targa}"] = {"targa": targa, "autista": autista, "km_p": km_p, "step": 1}
            
        elif azione == "arrivo_dest":
            dest = request.form.get("destinazione")
            km_d = int(request.form.get("km_destinazione"))
            stato_globale[targa]["posizione"] = dest
            stato_globale[targa]["km"] = km_d
            salva_stato(stato_globale)
            session[f"corsa_{targa}"]["step"] = 2
            session[f"corsa_{targa}"]["dest"] = dest
            session[f"corsa_{targa}"]["km_d"] = km_d
            session.modified = True

        elif azione == "stop":
            km_f = int(request.form.get("km_rientro"))
            # Controllo Manutenzione (esempio ogni 20.000 km)
            alert = "⚠️ TAGLIANDO VICINO" if km_f % 20000 > 19500 else ""
            
            stato_globale[targa] = {
                "stato": "Libero",
                "posizione": "Tiburtina",
                "km": km_f,
                "autista": "-",
                "alert": alert
            }
            salva_stato(stato_globale)
            session.pop(f"corsa_{targa}", None)
            # Qui andrebbe la logica del PDF (omessa per brevità, resta uguale a prima)
            return redirect("/")

    return render_template("form.html", furgoni=stato_globale)
