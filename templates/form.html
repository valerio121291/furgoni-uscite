<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Logistica CSA - Sistema Robusto</title>
    <style>
        body { font-family: sans-serif; background: #0f172a; color: white; padding: 20px; text-align: center; }
        .container { max-width: 400px; margin: auto; background: #1e293b; padding: 25px; border-radius: 20px; }
        input, select { width: 100%; padding: 12px; margin: 10px 0; border-radius: 10px; border: 1px solid #334155; background: #0f172a; color: white; box-sizing: border-box; }
        .mic-btn { background: #38bdf8; color: #0f172a; padding: 20px; width: 100%; border: none; border-radius: 15px; cursor: pointer; font-weight: bold; }
        .recording { background: #ef4444; animation: pulse 1s infinite; }
        #debug-text { color: #94a3b8; font-size: 0.8rem; margin-top: 15px; background: #000; padding: 10px; border-radius: 5px; min-height: 20px; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <h2>üöö Dashboard Vocale</h2>
    
    <input type="text" id="targa_field" placeholder="Targa (es. GA087CH)">
    <input type="text" id="autista_field" placeholder="Nome Autista">
    <input type="number" id="km_field" placeholder="Kilometri">
    <input type="text" id="partenza_field" placeholder="Partenza">

    <button class="mic-btn" id="startBtn">üéôÔ∏è PREMI E PARLA CHIARO</button>
    <div id="debug-text">In attesa...</div>
</div>

<script>
    const startBtn = document.getElementById('startBtn');
    const debug = document.getElementById('debug-text');

    // Mappe locali per velocizzare l'analisi
    const furgoni = { "piccolo": "GA087CH", "medio": "GX942TS", "grande": "GG862HC", "grosso": "GG862HC" };
    const autisti = ["Valerio", "Daniele", "Costantino", "Simone", "Stefano"];

    if ('webkitSpeechRecognition' in window) {
        const rec = new webkitSpeechRecognition();
        rec.lang = 'it-IT';
        rec.continuous = false;

        startBtn.onclick = () => { rec.start(); startBtn.classList.add('recording'); };

        rec.onresult = (event) => {
            startBtn.classList.remove('recording');
            const testo = event.results[0][0].transcript.toLowerCase();
            debug.innerText = "Hai detto: " + testo;

            // --- LOGICA 1: ANALISI LOCALE IMMEDIATA ---
            // Cerca furgone
            for (let key in furgoni) {
                if (testo.includes(key)) document.getElementById('targa_field').value = furgoni[key];
            }
            // Cerca autista
            autisti.forEach(a => {
                if (testo.includes(a.toLowerCase())) document.getElementById('autista_field').value = a;
            });
            // Cerca KM (cerca sequenza di numeri)
            const numeri = testo.match(/\d+/g);
            if (numeri) document.getElementById('km_field').value = numeri[0];

            // --- LOGICA 2: RIFINITURA CON IA ---
            fetch('/elabora_voce', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({testo: testo})
            })
            .then(res => res.json())
            .then(data => {
                console.log("Dati IA:", data);
                // Sovrascrivi solo se l'IA ha trovato qualcosa di meglio
                if(data.targa) document.getElementById('targa_select').value = data.targa;
                if(data.autista) document.getElementById('autista_field').value = data.autista;
                if(data.km) document.getElementById('km_field').value = data.km.toString().replace(/\D/g, "");
                if(data.partenza) document.getElementById('partenza_field').value = data.partenza;
                debug.innerText = "‚úÖ Analisi IA completata";
            })
            .catch(err => {
                debug.innerText = "‚ö†Ô∏è Analisi locale fatta, IA non raggiungibile.";
            });
        };
    }
</script>
</body>
</html>
