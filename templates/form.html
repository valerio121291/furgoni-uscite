<!doctype html>
<html lang="it">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Logistica CSA - IA</title>
    <style>
        :root { --bg-dark: #020617; --card-dark: #1e293b; --accent: #38bdf8; --success: #22c55e; --warning: #f59e0b; --text-main: #f8fafc; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-dark); margin: 0; padding-bottom: 100px; color: var(--text-main); }
        .header { background: #000; color: var(--accent); padding: 25px; text-align: center; font-weight: 800; font-size: 1.6rem; border-bottom: 3px solid var(--accent); text-transform: uppercase; letter-spacing: 2px; }
        .status-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 15px; }
        .truck-card { background: var(--card-dark); padding: 15px 2px; border-radius: 15px; text-align: center; border: 1px solid #334155; }
        .truck-card.In.Viaggio { border: 2px solid var(--warning); box-shadow: 0 0 15px rgba(245, 158, 11, 0.4); }
        .truck-card.Libero { border: 2px solid var(--success); }
        .furgone-icon { font-size: 1.2rem; display: block; margin-bottom: 5px; }
        .main-container { padding: 0 15px; }
        .card { background: var(--card-dark); padding: 25px; border-radius: 24px; border: 1px solid #334155; }
        label { display: block; margin-top: 15px; font-weight: 700; font-size: 0.85rem; color: var(--accent); text-transform: uppercase; }
        select, input { width: 100%; padding: 16px; margin-top: 8px; border-radius: 12px; border: 1px solid #475569; background: #0f172a; color: white; font-size: 1rem; box-sizing: border-box; }
        .btn { width: 100%; padding: 20px; margin-top: 25px; border-radius: 15px; border: none; font-size: 1.1rem; font-weight: 800; color: white; cursor: pointer; text-transform: uppercase; }
        .btn-start { background: linear-gradient(135deg, #0284c7, #0369a1); }
        .btn-next { background: linear-gradient(135deg, #d97706, #b45309); }
        .btn-stop { background: linear-gradient(135deg, #16a34a, #15803d); }
        .progress-bar { display: flex; justify-content: space-between; margin-bottom: 30px; position: relative; }
        .progress-step { width: 35px; height: 35px; background: #334155; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; z-index: 2; }
        .progress-step.active { background: var(--accent); color: #000; box-shadow: 0 0 15px var(--accent); }
        .progress-line { position: absolute; top: 17px; left: 0; right: 0; height: 3px; background: #334155; z-index: 1; }
        .info-active { background: #0c4a6e; border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center; border: 1px solid var(--accent); }
        #voiceBtn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 80px; height: 80px; border-radius: 50%; background: var(--accent); border: 4px solid white; box-shadow: 0 0 25px rgba(56, 189, 248, 0.6); cursor: pointer; font-size: 35px; z-index: 100; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>
    <div class="header">LOGISTICA CSA</div>
    <div class="status-container">
        <div class="truck-card {{ furgoni['GA087CH'].stato }}"><span class="furgone-icon">ğŸšš</span><strong>GA087CH</strong><span>{{ furgoni['GA087CH'].stato }}</span></div>
        <div class="truck-card {{ furgoni['GX942TS'].stato }}"><span class="furgone-icon">ğŸššğŸšš</span><strong>GX942TS</strong><span>{{ furgoni['GX942TS'].stato }}</span></div>
        <div class="truck-card {{ furgoni['GG862HC'].stato }}"><span class="furgone-icon">ğŸššğŸššğŸšš</span><strong>GG862HC</strong><span>{{ furgoni['GG862HC'].stato }}</span></div>
    </div>
    <div class="main-container"><div class="card"><form method="post">
        {% if not targa_attiva %}
            <div class="progress-bar"><div class="progress-line"></div><div class="progress-step active">1</div><div class="progress-step">2</div><div class="progress-step">3</div></div>
            <label>Seleziona Furgone</label><select name="targa" required><option value="GA087CH">ğŸšš GA087CH</option><option value="GX942TS">ğŸššğŸšš GX942TS</option><option value="GG862HC">ğŸššğŸššğŸšš GG862HC</option></select>
            <label>Autista</label><select name="autista"><option>Valerio</option><option>Daniele</option><option>Costantino</option><option>Simone</option><option>Stefano</option></select>
            <label>Partenza</label><select name="partenza"><option value="Tiburtina">Tiburtina</option><option value="Rieti">Rieti</option><option value="L'Aquila">L'Aquila</option></select>
            <label>KM Iniziali</label><input type="number" name="km_partenza" placeholder="Inserisci KM" required>
            <button type="submit" name="azione" value="start" class="btn btn-start">Inizia Missione</button>
        {% else %}
            <div class="info-active"><strong style="font-size: 1.4rem;">{{ targa_attiva }}</strong><br><small>In missione con: {{ corsa_attiva.autista }}</small></div>
            <input type="hidden" name="targa" value="{{ targa_attiva }}">
            {% if corsa_attiva.step == 1 %}
                <label>Destinazione</label><select name="destinazione"><option value="Rieti">Rieti</option><option value="L'Aquila">L'Aquila</option><option value="Avezzano">Avezzano</option></select>
                <input type="number" name="km_destinazione" placeholder="KM Arrivo" required>
                <button type="submit" name="azione" value="arrivo_dest" class="btn btn-next">Registra Arrivo</button>
            {% elif corsa_attiva.step == 2 %}
                <label>KM Rientro</label><input type="number" name="km_rientro" placeholder="KM Finali" required>
                <button type="submit" name="azione" value="stop" class="btn btn-stop">Chiudi e Invia PDF</button>
            {% endif %}
            <button type="submit" name="azione" value="annulla" style="background:none; border:none; color:#64748b; width:100%; margin-top:30px;">Ã— Annulla</button>
        {% endif %}
    </form></div></div>
    <button id="voiceBtn" type="button">ğŸ™ï¸</button>
    <script>
        const voiceBtn = document.getElementById('voiceBtn');
        const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
        recognition.lang = 'it-IT';
        voiceBtn.onclick = () => { recognition.start(); voiceBtn.style.background = 'red'; };
        recognition.onresult = (event) => {
            const transcript = event.results[0][0].transcript;
            voiceBtn.style.background = 'var(--accent)';
            fetch('/chat_ia', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({messaggio: transcript}) })
            .then(r => r.json()).then(data => {
                if(data.partenza) { let s = document.querySelector('select[name="partenza"]'); if(s) s.add(new Option(data.partenza, data.partenza, true, true)); }
                if(data.km) { let i = document.querySelector('input[name="km_partenza"]') || document.querySelector('input[name="km_destinazione"]') || document.querySelector('input[name="km_rientro"]'); if(i) i.value = data.km.replace(/\D/g,''); }
                if(data.destinazione) { let s = document.querySelector('select[name="destinazione"]'); if(s) s.add(new Option(data.destinazione, data.destinazione, true, true)); }
                window.speechSynthesis.speak(new SpeechSynthesisUtterance(data.risposta || "Dati inseriti."));
            });
        };
    </script>
</body>
</html>
